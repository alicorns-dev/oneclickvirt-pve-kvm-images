name: Build PVE KVM images from official sources
on:
  schedule:
    - cron: '34 4 * * *'
  workflow_dispatch:

env:
  LIBGUESTFS_BACKEND: direct

jobs:
  build_pve_kvm_images:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        # æ¸…ç†GitHub runnerçš„ç£ç›˜ç©ºé—´
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h

    - name: Configure Git
      run: |
        git config --global user.name "daily-update"
        git config --global user.email "tg@spiritlhl.top"

    - name: Environment preparation
      run: |
        sudo apt-get update
        sudo apt-get install -y curl wget unzip zip jq
        
        # å®‰è£…libguestfså·¥å…· - GitHub runneræ”¯æŒçš„ç‰ˆæœ¬
        sudo apt-get install -y libguestfs-tools qemu-utils
        
        # è®¾ç½®libguestfsç¯å¢ƒå˜é‡ï¼ˆGitHub runneræ²¡æœ‰KVMï¼‰
        export LIBGUESTFS_BACKEND=direct
        export LIBGUESTFS_DEBUG=1 
        export LIBGUESTFS_TRACE=1
        
        # æ£€æŸ¥å¯ç”¨å·¥å…·
        which virt-customize || echo "virt-customize not available"
        which qemu-img || echo "qemu-img not available"

        curl -o rebuild_qcow2.sh https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/rebuild_qcow2.sh
        chmod 777 rebuild_qcow2.sh

    - name: Download official qcow2 images
      run: |
        mkdir -p images
        cd images
        
        echo "å¼€å§‹ä¸‹è½½å®˜æ–¹é•œåƒ..."
        
        # Ubuntu 24.04 LTS (Noble)
        echo "æ­£åœ¨ä¸‹è½½ Ubuntu 24.04 LTS..."
        curl -L --retry 3 --retry-delay 10 -o noble-server-cloudimg-amd64.img \
          "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img" || echo "Ubuntu 24.04 ä¸‹è½½å¤±è´¥"
        
        # Ubuntu 22.04 LTS (Jammy) 
        echo "æ­£åœ¨ä¸‹è½½ Ubuntu 22.04 LTS..."
        curl -L --retry 3 --retry-delay 10 -o jammy-server-cloudimg-amd64.img \
          "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img" || echo "Ubuntu 22.04 ä¸‹è½½å¤±è´¥"
        
        # Debian 12 (Bookworm)
        echo "æ­£åœ¨ä¸‹è½½ Debian 12..."
        curl -L --retry 3 --retry-delay 10 -o debian-12-nocloud-amd64.qcow2 \
          "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-nocloud-amd64.qcow2" || echo "Debian 12 ä¸‹è½½å¤±è´¥"
        
        # Debian 11 (Bullseye) 
        echo "æ­£åœ¨ä¸‹è½½ Debian 11..."
        curl -L --retry 3 --retry-delay 10 -o debian-11-nocloud-amd64.qcow2 \
          "https://cloud.debian.org/images/cloud/bullseye/latest/debian-11-nocloud-amd64.qcow2" || echo "Debian 11 ä¸‹è½½å¤±è´¥"
        
        # AlmaLinux 9
        echo "æ­£åœ¨ä¸‹è½½ AlmaLinux 9..."
        curl -L --retry 3 --retry-delay 10 -o AlmaLinux-9-GenericCloud-latest.x86_64.qcow2 \
          "https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2" || echo "AlmaLinux 9 ä¸‹è½½å¤±è´¥"
        
        # AlmaLinux 8
        echo "æ­£åœ¨ä¸‹è½½ AlmaLinux 8..."
        curl -L --retry 3 --retry-delay 10 -o AlmaLinux-8-GenericCloud-latest.x86_64.qcow2 \
          "https://repo.almalinux.org/almalinux/8/cloud/x86_64/images/AlmaLinux-8-GenericCloud-latest.x86_64.qcow2" || echo "AlmaLinux 8 ä¸‹è½½å¤±è´¥"
        
        # Rocky Linux 9
        echo "æ­£åœ¨ä¸‹è½½ Rocky Linux 9..."
        curl -L --retry 3 --retry-delay 10 -o Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 \
          "https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2" || echo "Rocky Linux 9 ä¸‹è½½å¤±è´¥"
        
        # Rocky Linux 8
        echo "æ­£åœ¨ä¸‹è½½ Rocky Linux 8..."
        curl -L --retry 3 --retry-delay 10 -o Rocky-8-GenericCloud-Base.latest.x86_64.qcow2 \
          "https://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-GenericCloud-Base.latest.x86_64.qcow2" || echo "Rocky Linux 8 ä¸‹è½½å¤±è´¥"
        
        # CentOS Stream 9
        echo "æ­£åœ¨ä¸‹è½½ CentOS Stream 9..."
        curl -L --retry 3 --retry-delay 10 -o CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2 \
          "https://cloud.centos.org/centos/9-stream/x86_64/images/CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2" || echo "CentOS Stream 9 ä¸‹è½½å¤±è´¥"
        
        # Fedora (è·å–æœ€æ–°ç‰ˆæœ¬å·)
        echo "æ­£åœ¨ä¸‹è½½ Fedora..."
        FEDORA_LATEST=$(curl -s https://dl.fedoraproject.org/pub/fedora/linux/releases/ | grep -o 'href="[0-9]*/"' | sed 's/href="//;s/\/"//g' | sort -n | tail -1)
        echo "æ£€æµ‹åˆ° Fedora ç‰ˆæœ¬: $FEDORA_LATEST"
        if [ ! -z "$FEDORA_LATEST" ]; then
          curl -L --retry 3 --retry-delay 10 -o Fedora-Cloud-Base-$FEDORA_LATEST.x86_64.qcow2 \
            "https://dl.fedoraproject.org/pub/fedora/linux/releases/$FEDORA_LATEST/Cloud/x86_64/images/Fedora-Cloud-Base-$FEDORA_LATEST.x86_64.qcow2" || echo "Fedora ä¸‹è½½å¤±è´¥"
        fi
        
        # Arch Linux
        echo "æ­£åœ¨ä¸‹è½½ Arch Linux..."
        curl -L --retry 3 --retry-delay 10 -o Arch-Linux-x86_64-cloudimg.qcow2 \
          "https://geo.mirror.pkgbuild.com/images/latest/Arch-Linux-x86_64-cloudimg.qcow2" || echo "Arch Linux ä¸‹è½½å¤±è´¥"
        
        # æ˜¾ç¤ºä¸‹è½½ç»“æœ
        echo "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        for file in *.img *.qcow2; do
          if [ -f "$file" ]; then
            size=$(du -h "$file" | cut -f1)
            echo "âœ… $file ($size)"
          fi
        done
        
        # æ˜¾ç¤ºç£ç›˜ç©ºé—´
        echo "å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -h .
        
        cd ..

    - name: Process images with qemu-img (GitHub Runner Compatible)
      run: |
        cd images
        
        # è·å–release ID
        release_id=$(curl -s -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/images" | jq -r '.id')
        
        if [ "$release_id" == "null" ]; then
          echo "âŒ Release 'images' ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºrelease"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ° release ID: $release_id"
        
        # å¤„ç†æ¯ä¸ªé•œåƒæ–‡ä»¶
        for file in *.img *.qcow2; do
          if [ -f "$file" ] && [ $(stat -c %s "$file") -gt 10485760 ]; then

            # å¤åˆ¶åŸæ–‡ä»¶
            cp "$file" "../$file"
            cd ..

            echo "ä½¿ç”¨GitHub runnerå…¼å®¹çš„å¤„ç†æ–¹æ³•"
            # ä½¿ç”¨GitHub runnerå…¼å®¹çš„å¤„ç†æ–¹æ³•
            bash -x ./rebuild_qcow2.sh "$file"
            
            # æ£€æŸ¥å¤„ç†åçš„æ–‡ä»¶
            if [ -f "$file" ] && [ $(stat -c %s "$file") -gt 10485760 ] && [ $(stat -c %s "$file") -le 3221225472 ]; then
              echo "âœ… æ–‡ä»¶å¤„ç†æˆåŠŸ: $file ($(du -h "$file" | cut -f1))"
              
              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
              existing_asset_id=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets" | \
                jq -r --arg name "$(basename "$file")" '.[] | select(.name == $name) | .id')
              
              if [ -n "$existing_asset_id" ] && [ "$existing_asset_id" != "null" ]; then
                echo "ğŸ—‘ï¸  åˆ é™¤å·²å­˜åœ¨çš„æ–‡ä»¶: $file"
                curl -s -X DELETE \
                  -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${{ github.repository }}/releases/assets/$existing_asset_id"
              fi
              
              echo "â¬†ï¸  ä¸Šä¼ æ–‡ä»¶: $file"
              curl -s \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                -T "$file" \
                "https://uploads.github.com/repos/${{ github.repository }}/releases/$release_id/assets?name=$(basename "$file")"
              
              echo "âœ… ä¸Šä¼ å®Œæˆ: $file"
              rm -f "$file"
            else
              echo "âŒ æ–‡ä»¶å¤„ç†å¤±è´¥æˆ–å¤§å°ä¸ç¬¦åˆè¦æ±‚: $file"
            fi
            
            cd images
          else
            echo "â­ï¸  è·³è¿‡æ–‡ä»¶: $file (æ–‡ä»¶å¤ªå°æˆ–ä¸å­˜åœ¨)"
          fi
        done
        
        echo "ğŸ‰ æ‰€æœ‰é•œåƒå¤„ç†å®Œæˆ"
